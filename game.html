<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
    <link href='https://fonts.googleapis.com/css?family=Racing Sans One' rel='stylesheet'>
    <link rel="icon" href="https://raw.githubusercontent.com/over-lords/overlords/4c614c1ffe5a9d7194202bd24fae5e7c99d86333/Public/Images/Site%20Assets/favicon.png" type="image/png">
    <link rel="stylesheet" href="style.css">
    <title>Overlords</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: auto;
        }

        .container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100svh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #game-board-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: auto;
        }

        #game-board {
            display: block;
            width: auto;
            height: auto;

            max-width: 100%;
            max-height: 100%;

            border: 4px solid white;
            border-radius: 8px;
            box-sizing: border-box;
            user-select: none;
            pointer-events: none;
            object-fit: contain;
        }

        .city-slot .card-wrapper {
            transform: scale(0.80);
            transform-origin: top left;
        }

        #city-grid-wrapper {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: center center;
            z-index: 10;
            pointer-events: none;
        }
        #city-grid {
            display: flex;
            gap: 22px;
            pointer-events: none;
        }

        .city-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        .city-slot {
            width: 200px;
            height: 300px;
            background: rgba(0,0,0,0.25);
            border: 2px solid black;
            border-radius: 8px;
            box-shadow: 2px 3px 5px rgba(0,0,0,0.35);
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
        }
        .city-slot .card-wrapper {
            transform: scale(0.80);       /* SHRINK TO FIT */
            transform-origin: top left;
        }
        .city-spacer {
            width: 200px;
            height: 32px;
            background: #fff;
            border: 2px solid black;
            border-radius: 6px;
            font-family: 'Racing Sans One', sans-serif;
            font-size: 18px;
            font-weight: bold;
            color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        .city-slot img.city-image {
            width: 100%;
            height: 100%;
            object-fit: cover;         /* fill slot and crop excess */
            object-position: center;   /* crop from center */
            pointer-events: none;
            border-radius: 8px;        /* match slot rounding */
        }

        #dropdown-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            max-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            background: rgba(255,255,255,0.97);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: max-height 0.45s ease;
            z-index: 9999;
        }

        #dropdown-tab {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.75);
            color: white;
            font-size: 24px;
            width: 40px;
            height: 28px;
            border-radius: 0 0 8px 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10000;
        }

        #dropdown-close {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.75);
            color: white;
            font-size: 24px;
            width: 40px;
            height: 28px;
            border-radius: 8px 8px 0 0;
            display: none; /* hidden until open */
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10000;
        }

        #dropdown-content {
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1 1 auto;
            padding: 20px;
        }
    </style>
</head>
<body style="background-color:white;">
    <div id="dropdown-tab">▼</div>
        <div id="dropdown-panel">
            <div id="dropdown-content"></div>
        </div>
    <div id="dropdown-close">▲</div>

    <div id="overlord-frame-box">
        <img id="overlord-frame-img" src="https://raw.githubusercontent.com/over-lords/overlords/7774da0ec26845edd8dc6c07756b04e78fafcbff/Public/Images/Site%20Assets/overlordBorder.png">
        <img id="overlord-cropped" src="">

        <div id="overlord-hp-container">
            <img id="overlord-heart" src="https://raw.githubusercontent.com/over-lords/overlords/7774da0ec26845edd8dc6c07756b04e78fafcbff/Public/Images/Card%20Assets/Misc/Heart.png">
            <div id="overlord-hp-text">0</div>
        </div>
    </div>

    <div id="overlord-panel">
        <div id="overlord-panel-close">X</div>
        <div id="overlord-panel-content"></div>
    </div>

    <div id="gameMenu-box">≡</div>

    <div id="sideMenu">
        <h2 id="menuHeader">Menu</h2>
        <div id="menuContent">

            <div id="menuMain">
                <div class="menu-button" id="menuVolumeBtn">Volume</div>
                <div class="menu-button" id="menuHelpBtn">Glossary</div>
                <div class="menu-button" id="menuQuitBtn">Quit</div>
            </div>

            <div id="menuVolume" style="display:none;">
                <div class="volume-row">
                    <label>Effects</label>
                    <input type="range" min="0" max="100" value="50" id="volSFX">
                </div>
                <div class="volume-row">
                    <label>Music</label>
                    <input type="range" min="0" max="100" value="50" id="volMusic">
                </div>
            </div>

            <div id="menuHelp" style="display:none;">
            <input id="helpSearch" type="text" placeholder="Search keywords...">

            <div id="helpList"></div>
            </div>
        </div>
    </div>

    <div id="quitPopup">
        <h2>Are you sure?</h2>
            <button id="quitYes">Yes</button>
            <button id="quitNo">No</button>
    </div>

    <div class="bg-image" alt="" style="opacity: 35%;"></div>

    <div class="container">
        <div id="game-board-container">
            <img id="game-board"
                alt="Overlords Board"
                style="opacity: 75%;"
                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/BoardReduced.jpg">

            <div id="city-grid-wrapper">
                <div id="city-grid">
                    <div class="city-column">
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/starUpper.jpg">
                        </div>
                        <div class="city-spacer">Star City</div>
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/starLower.jpg">
                        </div>
                    </div>

                    <div class="city-column">
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/coastUpper.jpg">
                        </div>
                        <div class="city-spacer">Coast City</div>
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/coastLower.jpg">
                        </div>
                    </div>

                    <div class="city-column">
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/keystoneUpper.jpg">
                        </div>
                        <div class="city-spacer">Keystone City</div>
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/keystoneLower.jpg">
                        </div>
                    </div>

                    <div class="city-column">
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/centralUpper.jpg">
                        </div>
                        <div class="city-spacer">Central City</div>
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/centralLower.jpg">
                        </div>
                    </div>

                    <div class="city-column">
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/metropolisUpper.jpg">
                        </div>
                        <div class="city-spacer">Metropolis</div>
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/metropolisLower.jpg">
                        </div>
                    </div>

                    <div class="city-column">
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/gothamUpper.jpg">
                        </div>
                        <div class="city-spacer">Gotham City</div>
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/gothamLower.jpg">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { heroes } from './data/faceCards.js';
        import { overlords } from './data/overlords.js';
        import { tactics } from './data/tactics.js';
        import { enemies } from './data/enemies.js';
        import { allies } from './data/allies.js';
        import { bystanders } from './data/bystanders.js';
        import { scenarios } from './data/scenarios.js';
        import { henchmen } from './data/henchmen.js';
        import { villains } from './data/villains.js';
        import { renderCard } from './utils/cardRenderer.js';
        import { renderCountdown } from './utils/cardRenderer.js';
        import { keywords } from './data/keywords.js';

        let currentOverlord = null;
        let currentTactics = [];

        async function decryptData(cipherText, secretKey) {
            const data = atob(cipherText);
            const bytes = new Uint8Array([...data].map(c => c.charCodeAt(0)));
            const iv = bytes.slice(0, 12);
            const cipher = bytes.slice(12);

            const keyMaterial = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(secretKey));
            const key = await crypto.subtle.importKey(
                'raw',
                keyMaterial,
                { name: 'AES-GCM' },
                false,
                ['decrypt']
            );

            const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, cipher);
            const decoded = new TextDecoder().decode(decrypted);
            return JSON.parse(decoded);
        }

        (async () => {
            const params = new URLSearchParams(window.location.search);
            const encrypted = params.get('data');
            const SECRET = 'GeimonHeroKey42';  // DO NOT FUCK THIS UP

            if (!encrypted) {
                document.body.insertAdjacentHTML('beforeend', '<p style="color:red;">No loadout data found.</p>');
                return;
            }

            try {
                const selectedData = await decryptData(encrypted, SECRET);
                const selectedHeroes = selectedData.heroes || [];
                const selectedOverlords = selectedData.overlords || [];
                const selectedTactics = selectedData.tactics || [];

                const heroMap = new Map(heroes.map(h => [String(h.id), h]));
                const heroList = selectedHeroes.map(id => heroMap.get(String(id)) || { name: `Unknown (ID ${id})` });

                const overlordMap = new Map(overlords.map(o => [String(o.id), o]));
                const overlordList = selectedOverlords
                .map(id => overlordMap.get(String(id)) || { name: `Unknown (ID ${id})`, hp: '?', level: '?' })
                .sort((a, b) => a.level - b.level || a.hp - b.hp);

                if (overlordList.length > 0) {
                    setCurrentOverlord(overlordList[0]); // run setCurrentOverlord(newOverlordObject); whenever a takeover happens (from villains or overlord stack)
                }

                const tacticMap = new Map(tactics.map(t => [String(t.id), t]));
                const tacticList = selectedTactics.map(id => {
                    const t = tacticMap.get(String(id));
                    if (!t) return { name: `Unknown (ID ${id})`, abilitiesText: [{ text: '?' }] };
                    return t;
                });

                currentTactics = tacticList;

                const container = document.createElement('div');
                container.style.marginTop = '0px';
                container.style.textAlign = 'center';
                container.innerHTML = `
                    <h2>Loaded Heroes (in order selected):</h2>
                    <ol style="display:inline-block; text-align:left;">
                        ${heroList.map(h => `<li>${h.name}</li>`).join('')}
                    </ol>
                    <h2 style="margin-top:30px;">Loaded Overlords (sorted by difficulty & HP):</h2>
                    <ol style="display:inline-block; text-align:left;">
                        ${overlordList.map(o => `<li>${o.name} — ${o.hp} HP (Difficulty ${o.level})</li>`).join('')}
                    </ol>
                `;

                container.innerHTML += `
                    <h2 style="margin-top:30px;">Loaded Tactics:</h2>
                    <ol style="display:inline-block; text-align:left; max-width:700px;">
                        ${tacticList.map(t => `
                        <li style="margin-bottom:10px;">
                            <b>${t.name}</b><br>
                            ${t.abilitiesText.map(a => a.text).join('<br><br>')}
                        </li>
                        `).join('')}
                    </ol>
                `;

                const enemiesData = selectedData.enemies || {};
                const alliesData = selectedData.allies || {};

                const selectedEnemies = Array.isArray(enemiesData.ids) ? enemiesData.ids : [];
                const selectedAllies = Array.isArray(alliesData.ids) ? alliesData.ids : [];

                const enemiesCount = typeof enemiesData.count === "number"
                    ? enemiesData.count
                    : selectedEnemies.length;

                const alliesCount = typeof alliesData.count === "number"
                    ? alliesData.count
                    : selectedAllies.length;

                const enemyMap = new Map(enemies.map(e => [String(e.id), e.name]));
                const allyMap = new Map(allies.map(a => [String(a.id), a.name]));

                container.innerHTML += `
                    <h2 style="margin-top:30px;">Enemies & Allies:</h2>
                    <div style="display:flex; justify-content:center; gap:60px; text-align:left;">
                        <div>
                        <b>Enemies (${enemiesCount} chosen)</b><br>
                        <ul>${
                            selectedEnemies.length
                            ? selectedEnemies.map(id => `<li>${enemyMap.get(String(id)) || `Unknown (${id})`}</li>`).join('')
                            : '<li>None selected</li>'
                        }</ul>
                        </div>
                        <div>
                        <b>Allies (${alliesCount} chosen)</b><br>
                        <ul>${
                            selectedAllies.length
                            ? selectedAllies.map(id => `<li>${allyMap.get(String(id)) || `Unknown (${id})`}</li>`).join('')
                            : '<li>None selected</li>'
                        }</ul>
                        </div>
                    </div>
                `;

                const vdeck = selectedData.villainDeck || {};

                const vd_mights = typeof vdeck.mights === 'number' ? vdeck.mights : 0;

                const vd_bys_count = Number(vdeck.bystanders?.count)||0;
                const vd_bys_types = Array.isArray(vdeck.bystanders?.byType) ? vdeck.bystanders.byType : [];

                const vd_scenarios = Array.isArray(vdeck.scenarios) ? vdeck.scenarios.map(String) : [];
                const scenMap = new Map(scenarios.map(s => [String(s.id), s]));

                const vd_hench_list = Array.isArray(vdeck.henchmen) ? vdeck.henchmen : [];
                const henchMap = new Map(henchmen.map(h=>[String(h.id), h]));

                const vd_villain_ids = Array.isArray(vdeck.villains) ? vdeck.villains.map(String) : [];
                const villainMap = new Map(villains.map(v=>[String(v.id), v]));

                const byBreakHTML = vd_bys_types.length
                    ? ('<ul style="margin:0;padding-left:18px;">'+vd_bys_types.filter(x=>x.count>0).map(x=>`<li>${x.count}× ${x.name || ('Type '+x.id)}</li>`).join('')+'</ul>')
                    : '<i>No bystanders</i>';

                const scenariosHTML = vd_scenarios.length
                    ? ('<ul style="margin:0;padding-left:18px;">'+vd_scenarios.map(id=>`<li>${scenMap.get(id)?.name || ('Unknown '+id)}</li>`).join('')+'</ul>')
                    : '<i>None selected</i>';

                const henchHTML = vd_hench_list.length
                    ? ('<ul style="margin:0;padding-left:18px;">'
                        + vd_hench_list.filter(x=>Number(x.count)>0).map(x=>{
                            const h = henchMap.get(String(x.id));
                            return `<li>${x.count}× ${h?.name || ('Hench '+x.id)}</li>`;
                            }).join('')
                        +'</ul>')
                    : '<i>None selected</i>';

                const vilsHTML = vd_villain_ids.length
                    ? ('<ul style="margin:0;padding-left:18px;">'+vd_villain_ids.map(id=>{
                            const v = villainMap.get(id);
                            return `<li>${v?.name || ('Villain '+id)}${v?` — ${v.hp} HP • ${v.damage} DMG`:''}</li>`;
                        }).join('')+'</ul>')
                    : '<i>None selected</i>';

                container.innerHTML += `
                    <h2 style="margin-top:30px;">Villain Deck</h2>
                    <div style="display:grid;grid-template-columns: 1fr 1fr; gap:24px; max-width:900px; margin:0 auto; text-align:left;">
                        <div>
                        <b>Mights:</b> ${vd_mights}
                        <br><br>
                        <b>Bystanders:</b> ${vd_bys_count}
                        <div style="margin-top:6px;">${byBreakHTML}</div>
                        <br>
                        <b>Scenarios (${vd_scenarios.length}):</b>
                        <div style="margin-top:6px;">${scenariosHTML}</div>
                        </div>
                        <div>
                        <b>Henchmen:</b>
                        <div style="margin-top:6px;">${henchHTML}</div>
                        <br>
                        <b>Villains (${vd_villain_ids.length}):</b>
                        <div style="margin-top:6px;">${vilsHTML}</div>
                        </div>
                    </div>
                `;

                document.getElementById("dropdown-content").appendChild(container);
            } catch (e) {
                console.error('Failed to decrypt data:', e);
                document.body.insertAdjacentHTML('beforeend', '<p style="color:red;">Invalid or corrupted data.</p>');
            }
        })();

        function resizeBoardToViewport() {
            const board = document.getElementById("game-board");
            const container = document.getElementById("game-board-container");

            const vh = window.visualViewport?.height || window.innerHeight || document.documentElement.clientHeight;
            const vw = window.visualViewport?.width  || window.innerWidth  || document.documentElement.clientWidth;

            const padding = 16;
            board.style.maxHeight = (vh - padding) + "px";
            board.style.maxWidth  = (vw - padding) + "px";

            scaleGridToBoard();
        }

        resizeBoardToViewport();

        if (window.visualViewport) {
            visualViewport.addEventListener("resize", resizeBoardToViewport);
            visualViewport.addEventListener("scroll", resizeBoardToViewport);
        }
        window.addEventListener("resize", resizeBoardToViewport);

        function scaleGridToBoard() {
            const board = document.getElementById("game-board");
            const wrapper = document.getElementById("city-grid-wrapper");
            const grid = document.getElementById("city-grid");

            const gridWidth = grid.scrollWidth;
            const gridHeight = grid.scrollHeight;

            const boardRect = board.getBoundingClientRect();
            const maxW = boardRect.width * 0.90;
            const maxH = boardRect.height * 0.80;

            const scale = Math.min(maxW / gridWidth, maxH / gridHeight);

            wrapper.style.transform = `translate(-50%, -50%) scale(${scale})`;
        }

        window.addEventListener("load", scaleGridToBoard);
        window.addEventListener("resize", scaleGridToBoard);

        const dropdownPanel = document.getElementById("dropdown-panel");
        const dropdownTab   = document.getElementById("dropdown-tab");
        const dropdownClose = document.getElementById("dropdown-close");

        dropdownTab.addEventListener("click", () => {
            dropdownPanel.style.maxHeight = "85vh";
            dropdownTab.style.display = "none";
            dropdownClose.style.display = "flex";
        });

        dropdownClose.addEventListener("click", () => {
            dropdownPanel.style.maxHeight = "0";

            dropdownClose.style.display = "none";

            setTimeout(() => {
                dropdownTab.style.display = "flex";
            }, 450);
        });

        const menuBtn = document.getElementById("gameMenu-box");
        const sideMenu = document.getElementById("sideMenu");
        const menuHeader = document.getElementById("menuHeader");

        const menuMain = document.getElementById("menuMain");
        const menuVolume = document.getElementById("menuVolume");
        const menuHelp = document.getElementById("menuHelp");

        const volSFX = document.getElementById("volSFX");
        const volMusic = document.getElementById("volMusic");

        const helpSearch = document.getElementById("helpSearch");
        const helpList = document.getElementById("helpList");

        const popup = document.getElementById("quitPopup");
        const quitYes = document.getElementById("quitYes");
        const quitNo = document.getElementById("quitNo");

        let menuOpen = false;
        let submenu = null;

        function loadKeywords() {
            helpList.innerHTML = "";
            const entries = Object.entries(keywords).sort((a,b)=>a[0].localeCompare(b[0]));
            for (let [name, text] of entries) {
                const div = document.createElement("div");
                div.className = "keyword-entry";
                div.innerHTML = `<b>${name}</b><br>${text}`;
                helpList.appendChild(div);
            }
        }
        loadKeywords();

        helpSearch.addEventListener("input", () => {
            const query = helpSearch.value.toLowerCase();
            const entries = Object.entries(keywords).sort((a,b)=>a[0].localeCompare(b[0]));

            helpList.innerHTML = "";

            for (let [name, text] of entries) {
                if ( name.toLowerCase().includes(query) || text.toLowerCase().includes(query) ) {
                    const div = document.createElement("div");
                    div.className = "keyword-entry";
                    div.innerHTML = `<b>${name}</b><br>${text}`;
                    helpList.appendChild(div);
                }
            }
        });

        menuBtn.addEventListener("click", () => {
            if (!menuOpen) {
                sideMenu.classList.add("open");
                menuBtn.style.backgroundColor = "red";
                menuBtn.textContent = "X";
                menuOpen = true;
            } else if (submenu === null) {
                sideMenu.classList.remove("open");
                menuBtn.style.backgroundColor = "rgb(79,196,255)";
                menuBtn.textContent = "≡";
                menuOpen = false;
            } else {
                submenu = null;
                menuHeader.textContent = "Menu";

                menuMain.style.display = "block";
                menuVolume.style.display = "none";
                menuHelp.style.display = "none";

                menuBtn.textContent = "X";
            }
        });

        document.getElementById("menuVolumeBtn").addEventListener("click", () => {
            submenu = "volume";
            menuHeader.textContent = "Volume";

            menuMain.style.display = "none";
            menuVolume.style.display = "block";
            menuHelp.style.display = "none";

            menuBtn.textContent = "←";
        });

        document.getElementById("menuHelpBtn").addEventListener("click", () => {
            submenu = "help";
            menuHeader.textContent = "Glossary";
            menuHeader.style.fontSize = "28px";

            menuMain.style.display = "none";
            menuVolume.style.display = "none";
            menuHelp.style.display = "block";

            menuBtn.textContent = "←";
        });

        document.getElementById("menuQuitBtn").addEventListener("click", () => {
            popup.style.display = "block";
        });

        quitNo.addEventListener("click", () => {
            popup.style.display = "none";
        });

        quitYes.addEventListener("click", () => {
            window.location.href = "index.html";
        });

        volSFX.addEventListener("input", ()=>{}); // DUMMY FOR NOW
        volMusic.addEventListener("input", ()=>{});

        function applyOverlordFrame(overlord) {
            if (!overlord) return;

            const imgEl = document.getElementById("overlord-cropped");
            const frameEl = document.getElementById("overlord-frame-img");

            // Put the overlord portrait into the cropped square
            imgEl.src = overlord.image;

            // Apply color mask to frame based on level
            let tint = "";

            if (overlord.level == 1) {
                tint = "brightness(1.8) sepia(1) saturate(500%) hue-rotate(10deg)";
            }
            if (overlord.level == 2) {
                tint = "brightness(1.4) sepia(1) saturate(500%) hue-rotate(-3deg)";
            }
            if (overlord.level == 3) {
                tint = "brightness(1.2) sepia(1) saturate(500%) hue-rotate(-30deg)";
            }

            frameEl.style.filter = tint;
        }

        function setCurrentOverlord(overlord) {
            if (!overlord) return;
            currentOverlord = overlord;

            applyOverlordFrame(overlord);

            const hpText = document.getElementById("overlord-hp-text");
            overlord.currentHP = overlord.currentHP ?? overlord.hp;
            hpText.textContent = overlord.currentHP;
        }

        import { renderAbilityText } from './utils/cardRenderer.js';

        /* === Left Panel Button (the entire overlord frame is clickable) === */
        document.getElementById("overlord-frame-box").addEventListener("click", () => {
            buildOverlordPanel(currentOverlord);
        });


        document.getElementById("overlord-panel-close").addEventListener("click", () => {
            document.getElementById("overlord-panel").classList.remove("open");
        });

        function extractKeywordsFromAbilities(abilitiesTextArr) {
            if (!Array.isArray(abilitiesTextArr)) return [];

            const found = new Set();

            const keywordNames = Object.keys(keywords); // from keywords.js

            abilitiesTextArr.forEach(a => {
                if (!a || !a.text) return;

                keywordNames.forEach(kw => {
                    const regex = new RegExp(`(^|[^A-Za-z0-9'])${kw}([^A-Za-z0-9']|$)`, "i");
                    if (regex.test(a.text)) {
                        found.add(kw);
                    }
                });
            });

            return Array.from(found);
        }

        /* === Build the entire left panel === */
        function buildOverlordPanel(overlord) {
            if (!overlord) return;

            const panel = document.getElementById("overlord-panel");
            const content = document.getElementById("overlord-panel-content");
            content.innerHTML = "";

            /* === Set panel color based on overlord.level === */
            if (overlord.level == 1) {
                panel.style.backgroundColor = "rgba(255, 255, 0, 0.85)";
                panel.style.borderRight = "4px solid #997700";
            } else if (overlord.level == 2) {
                panel.style.backgroundColor = "rgba(255, 140, 0, 0.85)";
                panel.style.borderRight = "4px solid #663300";
            } else {
                panel.style.backgroundColor = "rgba(255, 0, 0, 0.85)";
                panel.style.borderRight = "4px solid #550000";
            }

            /* === Overlord Card === */
            const cardContainer = document.createElement("div");
            cardContainer.classList.add("overlord-card-scale");
            cardContainer.style.margin = "0 auto";
            const rendered = renderCard(overlord.id, cardContainer);
            cardContainer.appendChild(rendered);

            /* === Overlord Stats === */
            const statsBox = document.createElement("div");
            statsBox.innerHTML = `
                <h2 style="margin: 4px 0;">${overlord.name}</h2>
                <div><strong>HP:</strong> ${overlord.currentHP ?? overlord.hp}</div>
            `;

            /* === Overlord Abilities === */
            const abilBox = document.createElement("div");
            abilBox.innerHTML = `<h3>Abilities</h3>`;
            overlord.abilitiesText.forEach(a => {
                const line = document.createElement("div");
                line.innerHTML = renderAbilityText(a.text);
                abilBox.appendChild(line);
            });

            const topRow = document.createElement("div");
            topRow.classList.add("overlord-top-row");

            const rightColumn = document.createElement("div");
            rightColumn.classList.add("overlord-right-column");

            rightColumn.appendChild(statsBox);
            rightColumn.appendChild(abilBox);

            topRow.appendChild(cardContainer);
            topRow.appendChild(rightColumn);

            content.appendChild(topRow);

            /* === Tactics List (alphabetical) === */
            const tacticNames = currentTactics
                .slice()
                .sort((a, b) => a.name.localeCompare(b.name));

            const tacticBox = document.createElement("div");
            tacticBox.innerHTML = `<h3>Tactics</h3>`;
            tacticNames.forEach(t => {
                const tDiv = document.createElement("div");
                tDiv.innerHTML = `<strong>${t.name}</strong><br>`;
                t.abilitiesText.forEach(a => {
                    const line = document.createElement("div");
                    line.innerHTML = renderAbilityText(a.text);
                    tDiv.appendChild(line);
                });
                tDiv.style.marginBottom = "8px";
                tacticBox.appendChild(tDiv);
            });
            content.appendChild(tacticBox);

            /* === Keyword Extraction === */
            const extractedOverlordKeys = extractKeywordsFromAbilities(overlord.abilitiesText);
            const extractedTacticKeys  = currentTactics.flatMap(t => extractKeywordsFromAbilities(t.abilitiesText));

            const allKeywords = [...extractedOverlordKeys, ...extractedTacticKeys];

            // Unique & alphabetized
            const deduped = Array.from(new Set(allKeywords)).sort((a, b) => a.localeCompare(b));

            const keyBox = document.createElement("div");
            keyBox.innerHTML = `<h3>Keywords</h3>`;

            if (deduped.length === 0) {
                const none = document.createElement("div");
                none.style.fontStyle = "italic";
                none.style.color = "#222";
                none.textContent = "No Keywords Found";
                keyBox.appendChild(none);
                content.appendChild(keyBox);
                panel.classList.add("open");
                return;
            }

            deduped.forEach(k => {
                const line = document.createElement("div");
                line.style.marginBottom = "6px";

                const definition = keywords[k] || "<i>No definition found.</i>";

                line.innerHTML = `
                    <div style="font-weight:bold;">${k}</div>
                    <div style="margin-left:8px;">${definition}</div>
                `;
                keyBox.appendChild(line);
            });

            content.appendChild(keyBox);

            panel.classList.add("open");
        }

        function adjustContentForMobileClipping() {
            const content = document.getElementById("overlord-panel-content");
            const panel = document.getElementById("overlord-panel");

            // Mobile Safari/Chrome "visual viewport" height
            const visualH = window.visualViewport?.height || window.innerHeight;

            // Fixed layout viewport height (what the panel used)
            const layoutH = window.innerHeight;

            // If visual viewport is SIGNIFICANTLY smaller (URL bar expanded)
            const needsBoost = visualH < layoutH - 20;

            if (needsBoost) {
                content.classList.add("scroll-boost");
            } else {
                content.classList.remove("scroll-boost");
            }
        }

        window.addEventListener("resize", adjustContentForMobileClipping);
        window.addEventListener("orientationchange", adjustContentForMobileClipping);
        window.addEventListener("DOMContentLoaded", adjustContentForMobileClipping);
    </script>
</body>
</html>