<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
    <link href='https://fonts.googleapis.com/css?family=Racing Sans One' rel='stylesheet'>
    <link rel="icon" href="https://raw.githubusercontent.com/over-lords/overlords/4c614c1ffe5a9d7194202bd24fae5e7c99d86333/Public/Images/Site%20Assets/favicon.png" type="image/png">
    <link rel="stylesheet" href="style.css">
    <title>Overlords</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: auto;
        }

        .container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100svh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #game-board-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: auto;
        }

        #game-board {
            display: block;
            width: auto;
            height: auto;

            max-width: 100%;
            max-height: 100%;

            border: 4px solid white;
            border-radius: 8px;
            box-sizing: border-box;
            user-select: none;
            pointer-events: none;
            object-fit: contain;
        }

        .city-slot .card-wrapper {
            transform: scale(0.80);
            transform-origin: top left;
        }

        #city-grid-wrapper {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: center center;
            z-index: 10;
            pointer-events: none;
        }
        #city-grid {
            display: flex;
            gap: 22px;
            pointer-events: none;
        }

        .city-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        .city-slot {
            width: 200px;      /* >184px shrunk card width */
            height: 300px;     /* >280px shrunk card height */
            background: rgba(0,0,0,0.25);
            border: 2px solid black;
            border-radius: 8px;
            box-shadow: 2px 3px 5px rgba(0,0,0,0.35);
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
        }
        .city-slot .card-wrapper {
            transform: scale(0.80);       /* SHRINK TO FIT */
            transform-origin: top left;
        }
        .city-spacer {
            width: 200px;
            height: 32px;
            background: #fff;
            border: 2px solid black;
            border-radius: 6px;
            font-family: 'Racing Sans One', sans-serif;
            font-size: 18px;
            font-weight: bold;
            color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        .city-slot img.city-image {
            width: 100%;
            height: 100%;
            object-fit: cover;         /* fill slot and crop excess */
            object-position: center;   /* crop from center */
            pointer-events: none;
            border-radius: 8px;        /* match slot rounding */
        }

        #dropdown-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            max-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            background: rgba(255,255,255,0.97);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: max-height 0.45s ease;
            z-index: 9999;
        }

        /* ▼ open tab at top */
        #dropdown-tab {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.75);
            color: white;
            font-size: 24px;
            width: 40px;
            height: 28px;
            border-radius: 0 0 8px 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10000;
        }

        /* ▲ close tab at bottom */
        #dropdown-close {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.75);
            color: white;
            font-size: 24px;
            width: 40px;
            height: 28px;
            border-radius: 8px 8px 0 0;
            display: none; /* hidden until open */
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10000;
        }

        #dropdown-content {
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1 1 auto;
            padding: 20px;
        }
    </style>
</head>
<body style="background-color:white;">
    <div id="dropdown-tab">▼</div>
        <div id="dropdown-panel">
            <div id="dropdown-content"></div>
        </div>
    <div id="dropdown-close">▲</div>

    <div class="bg-image" alt="" style="opacity: 35%;"></div>
    <div class="container">
        <div id="game-board-container">
        <img id="game-board"
            alt="Overlords Board"
            style="opacity: 75%;"
            src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/BoardReduced.jpg">

            <div id="city-grid-wrapper">
                <div id="city-grid">
                    <!-- STAR CITY -->
                    <div class="city-column">
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/starUpper.jpg">
                        </div>
                        <div class="city-spacer">Star City</div>
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/starLower.jpg">
                        </div>
                    </div>

                    <!-- COAST CITY -->
                    <div class="city-column">
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/coastUpper.jpg">
                        </div>
                        <div class="city-spacer">Coast City</div>
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/coastLower.jpg">
                        </div>
                    </div>

                    <!-- KEYSTONE -->
                    <div class="city-column">
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/keystoneUpper.jpg">
                        </div>
                        <div class="city-spacer">Keystone City</div>
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/keystoneLower.jpg">
                        </div>
                    </div>

                    <!-- CENTRAL CITY -->
                    <div class="city-column">
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/centralUpper.jpg">
                        </div>
                        <div class="city-spacer">Central City</div>
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/centralLower.jpg">
                        </div>
                    </div>

                    <!-- METROPOLIS -->
                    <div class="city-column">
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/metropolisUpper.jpg">
                        </div>
                        <div class="city-spacer">Metropolis</div>
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/metropolisLower.jpg">
                        </div>
                    </div>

                    <!-- GOTHAM CITY -->
                    <div class="city-column">
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/gothamUpper.jpg">
                        </div>
                        <div class="city-spacer">Gotham City</div>
                        <div class="city-slot">
                            <img class="city-image"
                                src="https://raw.githubusercontent.com/over-lords/overlords/fc271a8062837c99e1c991fb0aa263eb7ffc54d1/Public/Images/Site%20Assets/gothamLower.jpg">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { heroes } from './data/faceCards.js';
        import { overlords } from './data/overlords.js';
        import { tactics } from './data/tactics.js';
        import { enemies } from './data/enemies.js';
        import { allies } from './data/allies.js';
        import { bystanders } from './data/bystanders.js';
        import { scenarios } from './data/scenarios.js';
        import { henchmen } from './data/henchmen.js';
        import { villains } from './data/villains.js';
        import { renderCard } from './utils/cardRenderer.js';
        import { renderCountdown } from './utils/cardRenderer.js';

        async function decryptData(cipherText, secretKey) {
            const data = atob(cipherText);
            const bytes = new Uint8Array([...data].map(c => c.charCodeAt(0)));
            const iv = bytes.slice(0, 12);
            const cipher = bytes.slice(12);

            const keyMaterial = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(secretKey));
            const key = await crypto.subtle.importKey(
                'raw',
                keyMaterial,
                { name: 'AES-GCM' },
                false,
                ['decrypt']
            );

            const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, cipher);
            const decoded = new TextDecoder().decode(decrypted);
            return JSON.parse(decoded);
        }

        (async () => {
            const params = new URLSearchParams(window.location.search);
            const encrypted = params.get('data');
            const SECRET = 'GeimonHeroKey42';

            if (!encrypted) {
                document.body.insertAdjacentHTML('beforeend', '<p style="color:red;">No loadout data found.</p>');
                return;
            }

            try {
                const selectedData = await decryptData(encrypted, SECRET);
                const selectedHeroes = selectedData.heroes || [];
                const selectedOverlords = selectedData.overlords || [];
                const selectedTactics = selectedData.tactics || [];

                // HEROES
                const heroMap = new Map(heroes.map(h => [String(h.id), h]));
                const heroList = selectedHeroes.map(id => heroMap.get(String(id)) || { name: `Unknown (ID ${id})` });

                // OVERLORDS
                const overlordMap = new Map(overlords.map(o => [String(o.id), o]));
                const overlordList = selectedOverlords
                .map(id => overlordMap.get(String(id)) || { name: `Unknown (ID ${id})`, hp: '?', level: '?' })
                .sort((a, b) => a.level - b.level || a.hp - b.hp);

                // TACTICS
                const tacticMap = new Map(tactics.map(t => [String(t.id), t]));
                const tacticList = selectedTactics.map(id => {
                    const t = tacticMap.get(String(id));
                    if (!t) return { name: `Unknown (ID ${id})`, abilitiesText: [{ text: '?' }] };
                    return t;
                });

                // Create hero container
                const container = document.createElement('div');
                container.style.marginTop = '0px';
                container.style.textAlign = 'center';
                container.innerHTML = `
                <h2>Loaded Heroes (in order selected):</h2>
                <ol style="display:inline-block; text-align:left;">
                    ${heroList.map(h => `<li>${h.name}</li>`).join('')}
                </ol>
                <h2 style="margin-top:30px;">Loaded Overlords (sorted by difficulty & HP):</h2>
                <ol style="display:inline-block; text-align:left;">
                    ${overlordList.map(o => `<li>${o.name} — ${o.hp} HP (Difficulty ${o.level})</li>`).join('')}
                </ol>
                `;

                container.innerHTML += `
                <h2 style="margin-top:30px;">Loaded Tactics:</h2>
                <ol style="display:inline-block; text-align:left; max-width:700px;">
                    ${tacticList.map(t => `
                    <li style="margin-bottom:10px;">
                        <b>${t.name}</b><br>
                        ${t.abilitiesText.map(a => a.text).join('<br><br>')}
                    </li>
                    `).join('')}
                </ol>
                `;

                // Handle enemies and allies safely whether array or object
                const enemiesData = selectedData.enemies || {};
                const alliesData = selectedData.allies || {};

                const selectedEnemies = Array.isArray(enemiesData.ids) ? enemiesData.ids : [];
                const selectedAllies = Array.isArray(alliesData.ids) ? alliesData.ids : [];

                const enemiesCount = typeof enemiesData.count === "number"
                ? enemiesData.count
                : selectedEnemies.length;
                const alliesCount = typeof alliesData.count === "number"
                ? alliesData.count
                : selectedAllies.length;

                const enemyMap = new Map(enemies.map(e => [String(e.id), e.name]));
                const allyMap = new Map(allies.map(a => [String(a.id), a.name]));

                container.innerHTML += `
                <h2 style="margin-top:30px;">Enemies & Allies:</h2>
                <div style="display:flex; justify-content:center; gap:60px; text-align:left;">
                    <div>
                    <b>Enemies (${enemiesCount} chosen)</b><br>
                    <ul>${
                        selectedEnemies.length
                        ? selectedEnemies.map(id => `<li>${enemyMap.get(String(id)) || `Unknown (${id})`}</li>`).join('')
                        : '<li>None selected</li>'
                    }</ul>
                    </div>
                    <div>
                    <b>Allies (${alliesCount} chosen)</b><br>
                    <ul>${
                        selectedAllies.length
                        ? selectedAllies.map(id => `<li>${allyMap.get(String(id)) || `Unknown (${id})`}</li>`).join('')
                        : '<li>None selected</li>'
                    }</ul>
                    </div>
                </div>
                `;

                // -------- VILLAIN DECK --------
                const vdeck = selectedData.villainDeck || {};

                const vd_mights = typeof vdeck.mights === 'number' ? vdeck.mights : 0;

                const vd_bys_count = Number(vdeck.bystanders?.count)||0;
                const vd_bys_types = Array.isArray(vdeck.bystanders?.byType) ? vdeck.bystanders.byType : [];

                const vd_scenarios = Array.isArray(vdeck.scenarios) ? vdeck.scenarios.map(String) : [];
                const scenMap = new Map(scenarios.map(s => [String(s.id), s]));

                const vd_hench_list = Array.isArray(vdeck.henchmen) ? vdeck.henchmen : [];
                const henchMap = new Map(henchmen.map(h=>[String(h.id), h]));

                const vd_villain_ids = Array.isArray(vdeck.villains) ? vdeck.villains.map(String) : [];
                const villainMap = new Map(villains.map(v=>[String(v.id), v]));

                const byBreakHTML = vd_bys_types.length
                ? ('<ul style="margin:0;padding-left:18px;">'+vd_bys_types.filter(x=>x.count>0).map(x=>`<li>${x.count}× ${x.name || ('Type '+x.id)}</li>`).join('')+'</ul>')
                : '<i>No bystanders</i>';

                const scenariosHTML = vd_scenarios.length
                ? ('<ul style="margin:0;padding-left:18px;">'+vd_scenarios.map(id=>`<li>${scenMap.get(id)?.name || ('Unknown '+id)}</li>`).join('')+'</ul>')
                : '<i>None selected</i>';

                const henchHTML = vd_hench_list.length
                ? ('<ul style="margin:0;padding-left:18px;">'
                    + vd_hench_list.filter(x=>Number(x.count)>0).map(x=>{
                        const h = henchMap.get(String(x.id));
                        return `<li>${x.count}× ${h?.name || ('Hench '+x.id)}</li>`;
                        }).join('')
                    +'</ul>')
                : '<i>None selected</i>';

                const vilsHTML = vd_villain_ids.length
                ? ('<ul style="margin:0;padding-left:18px;">'+vd_villain_ids.map(id=>{
                        const v = villainMap.get(id);
                        return `<li>${v?.name || ('Villain '+id)}${v?` — ${v.hp} HP • ${v.damage} DMG`:''}</li>`;
                    }).join('')+'</ul>')
                : '<i>None selected</i>';

                container.innerHTML += `
                <h2 style="margin-top:30px;">Villain Deck</h2>
                <div style="display:grid;grid-template-columns: 1fr 1fr; gap:24px; max-width:900px; margin:0 auto; text-align:left;">
                    <div>
                    <b>Mights:</b> ${vd_mights}
                    <br><br>
                    <b>Bystanders:</b> ${vd_bys_count}
                    <div style="margin-top:6px;">${byBreakHTML}</div>
                    <br>
                    <b>Scenarios (${vd_scenarios.length}):</b>
                    <div style="margin-top:6px;">${scenariosHTML}</div>
                    </div>
                    <div>
                    <b>Henchmen:</b>
                    <div style="margin-top:6px;">${henchHTML}</div>
                    <br>
                    <b>Villains (${vd_villain_ids.length}):</b>
                    <div style="margin-top:6px;">${vilsHTML}</div>
                    </div>
                </div>
                `;

                document.getElementById("dropdown-content").appendChild(container);
            } catch (e) {
                console.error('Failed to decrypt data:', e);
                document.body.insertAdjacentHTML('beforeend', '<p style="color:red;">Invalid or corrupted data.</p>');
            }
        })();

        function resizeBoardToViewport() {
            const board = document.getElementById("game-board");
            const container = document.getElementById("game-board-container");

            const vh = window.visualViewport?.height || window.innerHeight || document.documentElement.clientHeight;
            const vw = window.visualViewport?.width  || window.innerWidth  || document.documentElement.clientWidth;
                    
            //container.style.height = vh + "px";
            //container.style.width  = vw + "px";

            const padding = 16;
            board.style.maxHeight = (vh - padding) + "px";
            board.style.maxWidth  = (vw - padding) + "px";

            scaleGridToBoard();
        }

        resizeBoardToViewport();

        if (window.visualViewport) {
            visualViewport.addEventListener("resize", resizeBoardToViewport);
            visualViewport.addEventListener("scroll", resizeBoardToViewport);
        }
        window.addEventListener("resize", resizeBoardToViewport);

        function scaleGridToBoard() {
            const board = document.getElementById("game-board");
            const wrapper = document.getElementById("city-grid-wrapper");
            const grid = document.getElementById("city-grid");

            // Natural grid size
            const gridWidth = grid.scrollWidth;
            const gridHeight = grid.scrollHeight;

            // Visible board box
            const boardRect = board.getBoundingClientRect();
            const maxW = boardRect.width * 0.90;  // slight padding
            const maxH = boardRect.height * 0.80; // slight padding

            // Required scale
            const scale = Math.min(maxW / gridWidth, maxH / gridHeight);

            wrapper.style.transform = `translate(-50%, -50%) scale(${scale})`;
        }

        window.addEventListener("load", scaleGridToBoard);
        window.addEventListener("resize", scaleGridToBoard);

        // === DROPDOWN TOGGLE LOGIC ===
        const dropdownPanel = document.getElementById("dropdown-panel");
        const dropdownTab   = document.getElementById("dropdown-tab");
        const dropdownClose = document.getElementById("dropdown-close");

        // OPEN ▼ — only visible when closed
        dropdownTab.addEventListener("click", () => {
            dropdownPanel.style.maxHeight = "85vh";
            dropdownTab.style.display = "none";      // hide open tab
            dropdownClose.style.display = "flex";    // show close tab at bottom
        });

        // CLOSE ▲ — only visible when open
        dropdownClose.addEventListener("click", () => {
            dropdownPanel.style.maxHeight = "0";

            dropdownClose.style.display = "none";  // hide close tab immediately

            // Show the open tab AFTER collapse animation
            setTimeout(() => {
                dropdownTab.style.display = "flex";
            }, 450);
        });
    </script>
</body>
</html>