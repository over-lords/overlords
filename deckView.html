<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <link href='https://fonts.googleapis.com/css?family=Racing Sans One' rel='stylesheet'>
  <link rel="icon" href="https://raw.githubusercontent.com/over-lords/overlords/4c614c1ffe5a9d7194202bd24fae5e7c99d86333/Public/Images/Site%20Assets/favicon.png" type="image/png">
  <link rel="stylesheet" href="style.css">
  <title>Overlords</title>
  <style>
    .scroll-container {
      position: relative;
      min-height: 100vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .deck-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 18px;
      margin: 200px 50px 50px 50px;
      padding: 20px;
      padding-left: 40px;
      padding-bottom: 50px;

      background-color: rgba(51, 51, 51, 0.85);
      border: 2px solid black;
      border-radius: 8px;
    }
    .deck-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 0px;
    }
    .deck-qty {
      flex-shrink: 0;
      text-align: center;
      font-weight: bold;
      font-family: 'Racing Sans One', sans-serif;
      font-size: 72px;
      line-height: 1;
      color: black;
      padding: 10px 14px;

      background-color: rgba(255, 255, 255, 0.7);
      border: 4px solid black;
      border-radius: 6px;
      box-sizing: border-box;

      width: 120px;
      margin-right: 14px;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow-x: hidden;
      overscroll-behavior: none;
    }
    .bg-image {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-image: url('https://raw.githubusercontent.com/over-lords/overlords/332d3e1b05c84f8b31022c7907034b6bd0e2db77/Public/Images/Site%20Assets/BoardReduced.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: -1;
      opacity: 0.55;
    }
    .card-wrapper {
      display: inline-block;
      transform: scale(0.8);
      transform-origin: top left;
      margin-bottom: -60px;
    }
  </style>
</head>
<body>
  <div class="bg-image" alt=""></div>

  <div class="scroll-container">
    <div class="title-box" id="title-box"></div>
    <h1 id="title-namePlate" class="glow-red" style="pointer-events: none; font-size: 3.3rem; margin-top: 10px;">Deck Preview</h1>

    <div class="deckTitle-box" id="deckTitle-box" style="pointer-events: none;">
      <h1 id="hero-title" class="glow-dynamic" style="pointer-events: none;"></h1>
    </div>
  </div>

  <div id="close-box">X</div>

  <script type="module">
    import { renderCard } from './utils/cardRenderer.js';
    import { heroCards } from './data/heroCards.js';
    import { heroes } from './data/faceCards.js';
    import { keywords } from './data/keywords.js';
    import { renderAbilityText } from './utils/cardRenderer.js';

    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const heroName = urlParams.get('name');

      // === Get DOM elements ===
      const titleEl = document.getElementById('hero-title');

      // === Find hero data ===
      const heroData = heroes.find(h => h.name === heroName);
      const teamFolder = "https://raw.githubusercontent.com/over-lords/overlords/dd9ae2da28accbb5f3dc8ea6a92612e64df47042/Public/Images/Card%20Assets/Misc";
      const teamIconMap = {
        Lantern: `${teamFolder}/Green Lantern.png`,
      };
      const getTeamIcon = (team) => teamIconMap[team] || `${teamFolder}/${encodeURIComponent(team)}.png`;

      // === Update title and hero name dynamically ===
      if (heroData) {
        if (titleEl) {
          titleEl.textContent = heroData.name;
          titleEl.style.color = heroData.color;
          titleEl.style.textShadow = `0 0 4px black`;
          titleEl.style.fontSize = "27.5px";
          titleEl.style.fontFamily = "'Racing Sans One', sans-serif";
        }
      } else {
        if (titleEl) {
          titleEl.textContent = heroName || 'Unknown Hero';
          titleEl.style.color = 'black';
          titleEl.style.textShadow = 'none';
        }
      }

      // === Hero Info Box (Collapsible) ===
      if (heroData) {
        // --- Outer wrapper ---
        const infoWrapper = document.createElement('div');
        infoWrapper.style.position = 'absolute';
        infoWrapper.style.top = '123px';
        infoWrapper.style.right = '50px';
        infoWrapper.style.width = '250px';
        infoWrapper.style.border = '2px solid black';
        infoWrapper.style.borderRadius = '8px';
        infoWrapper.style.overflow = 'hidden';
        infoWrapper.style.background = 'rgba(222,222,222,1)';
        infoWrapper.style.boxShadow = '2px 3px 8px rgba(0,0,0,0.3)';
        infoWrapper.style.transition = 'max-height 0.4s ease';

        // --- Header toggle line ---
        const toggleHeader = document.createElement('div');
        toggleHeader.textContent = 'Show Character Stats ▼';
        toggleHeader.style.fontFamily = "'Racing Sans One', sans-serif";
        toggleHeader.style.fontSize = '18px';
        toggleHeader.style.fontWeight = 'bold';
        toggleHeader.style.textAlign = 'center';
        toggleHeader.style.cursor = 'pointer';
        toggleHeader.style.padding = '6px 0';
        toggleHeader.style.background = 'rgba(255,255,255,1)';
        toggleHeader.style.borderBottom = '2px solid black';
        toggleHeader.style.userSelect = 'none';
        infoWrapper.appendChild(toggleHeader);

        // --- Content area ---
        const infoContent = document.createElement('div');
        infoContent.style.padding = '8px';
        infoContent.style.fontFamily = "'Racing Sans One', sans-serif";
        infoContent.style.fontSize = '16px';
        infoContent.style.color = 'black';
        infoContent.style.display = 'none'; // hidden by default

        // Teams row
        const teamDiv = document.createElement('div');
        teamDiv.style.display = 'flex';
        teamDiv.style.alignItems = 'center';
        const teamLabel = document.createElement('span');
        teamLabel.textContent = 'Teams: ';
        teamLabel.style.fontWeight = 'bold';
        teamDiv.appendChild(teamLabel);
        heroData.teams.forEach(t => {
          const img = document.createElement('img');
          img.src = getTeamIcon(t);
          img.style.width = '28px';
          img.style.height = 'auto';
          img.style.marginLeft = '5px';
          teamDiv.appendChild(img);
        });
        infoContent.appendChild(teamDiv);

        // Stats
        const makeStat = (label, value) => {
          const el = document.createElement('div');
          el.innerHTML = `<span style="font-weight:bold">${label}:</span> ${value}`;
          return el;
        };
        infoContent.appendChild(makeStat('HP', heroData.hp));
        infoContent.appendChild(makeStat('Damage Threshold', heroData.damageThreshold));
        infoContent.appendChild(makeStat('Travel Budget', heroData.travel));
        infoContent.appendChild(makeStat('Retreat Requirement', heroData.retreat));

        // Abilities
        const abilities = document.createElement('div');
        abilities.style.marginTop = '12px';
        const abilitiesLabel = document.createElement('span');
        abilitiesLabel.textContent = 'Abilities: ';
        abilitiesLabel.style.fontWeight = 'bold';
        abilities.appendChild(abilitiesLabel);
        const abilitiesContent = document.createElement('span');
        abilitiesContent.innerHTML = heroData.abilitiesText
          ? heroData.abilitiesText.map(a => a.text).join('<br>')
          : 'None';
        abilitiesContent.style.display = 'inline-block';
        abilitiesContent.style.marginLeft = '0.25em';
        abilities.appendChild(abilitiesContent);
        infoContent.appendChild(abilities);

        infoWrapper.appendChild(infoContent);
        document.querySelector('.scroll-container').appendChild(infoWrapper);

        // --- Toggle logic ---
        let isOpen = false;
        toggleHeader.addEventListener('click', () => {
          isOpen = !isOpen;
          if (isOpen) {
            infoContent.style.maxHeight = '0';
            infoContent.style.overflow = 'hidden';
            infoContent.style.transition = 'max-height 0.3s ease-out';
            infoContent.style.display = 'block';
            requestAnimationFrame(() => {
              infoContent.style.maxHeight = infoContent.scrollHeight + 'px';
            });
            toggleHeader.textContent = 'Hide Character Stats ▲';
          } else {
            infoContent.style.maxHeight = '0';
            setTimeout(() => (infoContent.style.display = 'none'), 300);
            toggleHeader.textContent = 'Show Character Stats ▼';
          }
        });
      }

      // === Create deck container ===
      const container = document.createElement('div');
      container.classList.add('deck-container');
      document.querySelector('.scroll-container').appendChild(container);

      // === Filter all cards for this hero ===
      const heroDeck = heroCards.filter(c => c.hero === heroName);
      if (heroDeck.length === 0) {
        const none = document.createElement('div');
        none.textContent = 'No cards found for this hero.';
        none.style.fontWeight = 'bold';
        none.style.color = 'black';
        none.style.fontSize = '36px';
        container.appendChild(none);
        return;
      }

      // === Render each card with its perDeck quantity ===
      heroDeck.forEach(cardData => {
        const row = document.createElement('div');
        row.classList.add('deck-row');
        row.style.alignItems = 'center'; // align card and text properly

        const qty = document.createElement('div');
        qty.classList.add('deck-qty');
        qty.textContent = `${cardData.perDeck}x`;

        const cardElement = renderCard(cardData.id);
        row.appendChild(qty);
        row.appendChild(cardElement);

        // === Info Panel beside the card ===
        const infoDiv = document.createElement('div');
        infoDiv.style.display = 'flex';
        infoDiv.style.flexDirection = 'column';
        infoDiv.style.justifyContent = 'flex-start';
        infoDiv.style.marginLeft = '12px';
        infoDiv.style.color = 'white';
        infoDiv.style.fontFamily = "'Racing Sans One', sans-serif";
        infoDiv.style.fontSize = '18px';
        infoDiv.style.maxWidth = '350px';
        infoDiv.style.lineHeight = '1.3em';

        const makeLine = (label, value) => {
          const line = document.createElement('div');
          line.innerHTML = `<b>${label}:</b> ${value ?? '—'}`;
          return line;
        };

        infoDiv.appendChild(makeLine('Name', cardData.name));
        infoDiv.appendChild(makeLine('Damage', cardData.damage));
        let effectText = 'None';
        if (Array.isArray(cardData.abilitiesText) && cardData.abilitiesText.length > 0) {
          const rawText = cardData.abilitiesText.map(a => a.text).join('<br>');
          effectText = renderAbilityText(rawText); // THIS parses [ICON:...] into <img> tags
        }
        infoDiv.appendChild(makeLine('Effect', effectText));

        // === Keyword detection (case-insensitive) ===
        const foundKeywords = [];
        if (Array.isArray(cardData.abilitiesText)) {
          // Combine all ability text, lowercase, and remove punctuation
          const allText = cardData.abilitiesText
            .map(a => a.text)
            .join(' ')
            .toLowerCase()
            .replace(/[^\w\s]/g, ''); // remove punctuation like ' , . ! ?

          for (const [key, definition] of Object.entries(keywords)) {
            const keywordLower = key.toLowerCase();
            const regex = new RegExp(`\\b${keywordLower}\\b`, 'i');
            if (regex.test(allText)) {
              foundKeywords.push({ key, definition });
            }
          }
        }

        if (foundKeywords.length > 0) {
          const kwHeader = document.createElement('div');
          kwHeader.innerHTML = `<b><u>Keyword Definitions</u></b>`;
          kwHeader.style.marginTop = '8px';
          infoDiv.appendChild(kwHeader);

          const kwList = document.createElement('ul');
          kwList.style.marginTop = '4px';
          kwList.style.marginBottom = '0';
          kwList.style.paddingLeft = '20px';

          foundKeywords.forEach(k => {
            const li = document.createElement('li');
            li.innerHTML = `<b>${k.key}:</b> ${k.definition}`;
            kwList.appendChild(li);
          });

          infoDiv.appendChild(kwList);
        }

        row.appendChild(infoDiv);
        container.appendChild(row);
      });
    });

    const closeBox = document.getElementById('close-box');
    if (closeBox) {
      closeBox.addEventListener('click', () => {
        const heroName = new URLSearchParams(window.location.search).get('name');
        // Try to find the hero category for return context
        import('./data/faceCards.js').then(module => {
          const heroData = module.heroes.find(h => h.name === heroName);
          const cat = heroData ? heroData.category : '';
          const returnUrl = `deckList.html?name=${encodeURIComponent(heroName)}&category=${encodeURIComponent(cat)}`;
          window.location.href = returnUrl;
        });
      });
    }
    </script>

</body>
</html>
