<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
    <link href='https://fonts.googleapis.com/css?family=Racing Sans One' rel='stylesheet'>
    <link rel="icon" href="https://raw.githubusercontent.com/over-lords/overlords/4c614c1ffe5a9d7194202bd24fae5e7c99d86333/Public/Images/Site%20Assets/favicon.png" type="image/png">
    <link rel="stylesheet" href="style.css">
    <title>Overlords</title>
</head>
<body style="background-color:white;">
    <div class="bg-image" alt="" style="opaCity: 35%;"></div>
    <div class="container">
        <div class="title-box" id="title-box"></div>
        <h1 class="glow-red" style="pointer-events: none;">Campaign</h1>

        <div id="close-box" onclick="location.href='singlePlayer.html'">X</div>

        <br><br><br><br><br><br>

        <!-- Campaign selector -->
        <div style="margin-top: 10px; width: 100%; display: flex; flex-direction: column; gap: 14px;">
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <div style="font-size: 32px; font-family: 'Racing Sans One', sans-serif; color: #fff; text-shadow: 0 0 6px #000; padding-left: 10px;">Campaign</div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; padding-left: 10px;">
                <label for="world-input" style="font-size: 22px; font-family: 'Racing Sans One', sans-serif; color: #fff; text-shadow: 0 0 6px #000;">World:</label>
                <select id="world-input" style="width: 110px; padding: 6px 8px; border-radius: 10px; border: 2px solid #333; background:#161623; color:#fff;">
                </select>
            </div>

            <div style="display: flex; gap: 12px; flex-wrap: nowrap; width: 100%; padding-left: 10px; padding-right: 30px; overflow-x: hidden;">
                <div id="level-list" style="flex: 1 1 60%; min-width: 0; max-height: 65vh; overflow-y: auto; background: rgba(0,0,0,0.5); border: 2px solid #333; border-radius: 12px; padding: 10px;"></div>
                <div style="flex: 1 1 30%; min-width: 0; background: rgba(0,0,0,0.5); border: 2px solid #333; border-radius: 12px; padding: 14px; display: flex; flex-direction: column; gap: 12px; justify-content: center; margin-right: 20px;">
                    <div id="selected-label" style="color:#fff; font-size:16px;">Select a level to play.</div>
                    <button id="play-btn" disabled style="padding: 12px 14px; font-size: 18px; font-weight: 800; border: 3px solid #000; border-radius: 12px; background: #444; color: #bbb; cursor: not-allowed;">Play</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase } from "./supabaseClient.js";

        async function loadCampaignFlags() {
            const uid = (typeof localStorage !== "undefined") ? localStorage.getItem("session_user_id") : null;
            if (!uid) {
                window.__campaignFlags = new Set();
                return;
            }
            try {
                const { data, error } = await supabase
                    .from("users")
                    .select("flags")
                    .eq("id", uid)
                    .single();
                if (error) {
                    console.warn("[Campaign] Failed to fetch user flags", error);
                    window.__campaignFlags = new Set();
                    return;
                }
                const flags = Array.isArray(data?.flags) ? data.flags.map(String) : [];
                window.__campaignFlags = new Set(flags);
            } catch (err) {
                console.warn("[Campaign] Unexpected error fetching flags", err);
                window.__campaignFlags = new Set();
            }
        }

        // Ensure flags are loaded before rendering list
        loadCampaignFlags().then(() => {
            if (typeof window.__campaignFlags === "undefined") {
                window.__campaignFlags = new Set();
            }
            if (typeof initializeCampaign === "function") {
                initializeCampaign();
            }
        });
    </script>

    <script>
        // Elements
        const listEl = document.getElementById("level-list");
        const playBtn = document.getElementById("play-btn");
        const selectedLabel = document.getElementById("selected-label");
        const worldInput = document.getElementById("world-input");

        let currentWorld = 1;
        let selectedLevel = null;
        let selectedFlag = null;
        let currentLevelList = [];

        async function fetchWorlds() {
            // Prefer GitHub directory listing
            try {
                const apiUrl = `https://api.github.com/repos/over-lords/overlords/contents/data/campaignLevels?ref=main`;
                const res = await fetch(apiUrl);
                if (res.ok) {
                    const data = await res.json();
                    if (Array.isArray(data)) {
                        const worlds = data
                            .map(item => item?.name)
                            .filter(name => /^world\d+$/i.test(String(name || "")));
                        // Verify each has at least one level
                        const available = [];
                        for (const wName of worlds) {
                            const num = Number(wName.replace(/[^0-9]/g, "")) || 0;
                            const levels = await fetchLevels(num, { skipWorldsCheck: true });
                            if (levels.length) available.push(num);
                        }
                        if (available.length) return Array.from(new Set(available)).sort((a,b)=>a-b);
                    }
                }
            } catch (_) {
                // ignore
            }
            // Fallback to world1
            return [1];
        }

        async function fetchLevels(world, opts = {}) {
            const base = `./data/campaignLevels/world${world}`;

            const normalizeList = (list) => Array.from(new Set(
                (list || [])
                    .map(name => String(name || ""))
                    .filter(n => n.toLowerCase().endsWith(".json"))
                    .map(n => n.replace(/\.json$/i, ""))
            ));

            // Try GitHub API (lists directory contents) unless skipped by caller
            if (!opts.skipWorldsCheck) {
                try {
                    const apiUrl = `https://api.github.com/repos/over-lords/overlords/contents/data/campaignLevels/world${world}?ref=main`;
                    const res = await fetch(apiUrl);
                    if (res.ok) {
                        const data = await res.json();
                        if (Array.isArray(data)) {
                            const names = data
                                .map(item => item?.name)
                                .filter(name => typeof name === "string" && name.toLowerCase().endsWith(".json"));
                            const norm = normalizeList(names);
                            if (norm.length) return norm;
                        }
                    }
                } catch (_) {
                    // ignore and fall through
                }
            }

            // If we get here, we failed
            return [];
        }

        function renderLevels(levels) {
            listEl.innerHTML = "";
            currentLevelList = levels || [];
            if (!levels.length) {
                listEl.innerHTML = `<div style="color:#fff; font-size:16px;">No levels found for world ${currentWorld}.</div>`;
                selectedLevel = null;
                selectedFlag = null;
                updatePlay();
                return;
            }

            levels.forEach((name, idx) => {
                const displayName = name.replace(/^(\d{2})-/, "");
                const flagName = `world${currentWorld}game${idx + 1}`;
                const row = document.createElement("div");
                row.style.cssText = `
                    padding: 12px 14px;
                    margin: 6px 0;
                    border-radius: 10px;
                    background: #1f1f2e;
                    border: 2px solid ${name === selectedLevel ? "#ffd800" : "transparent"};
                    color: #fff;
                    cursor: pointer;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    box-shadow: ${name === selectedLevel ? "0 0 10px rgba(255,216,0,0.5)" : "none"};
                `;
                const titleSpan = document.createElement("span");
                titleSpan.textContent = displayName;
                const statusSpan = document.createElement("span");
                statusSpan.textContent = (window.__campaignFlags && window.__campaignFlags.has(flagName)) ? "âœ”" : "";
                statusSpan.style.color = "#7cf57c";
                statusSpan.style.fontWeight = "bold";
                statusSpan.style.marginLeft = "8px";
                row.appendChild(titleSpan);
                row.appendChild(statusSpan);
                row.onclick = () => {
                    if (selectedLevel === name) {
                        selectedLevel = null;
                        selectedFlag = null;
                    } else {
                        selectedLevel = name;
                        selectedFlag = `world${currentWorld}game${idx + 1}`;
                    }
                    renderLevels(levels); // re-render to update selection highlight
                    updatePlay();
                };
                listEl.appendChild(row);
            });
        }

        function updatePlay() {
            if (selectedLevel) {
                selectedLabel.textContent = ``;
                playBtn.disabled = false;
                playBtn.style.background = "#ffd800";
                playBtn.style.color = "#000";
                playBtn.style.cursor = "pointer";
                playBtn.textContent = `Play`;
            } else {
                selectedLabel.textContent = "Select a level to play.";
                playBtn.disabled = true;
                playBtn.style.background = "#444";
                playBtn.style.color = "#bbb";
                playBtn.style.cursor = "not-allowed";
                playBtn.textContent = "Play";
            }
        }

        async function encryptData(data, secretKey) {
            const enc = new TextEncoder();
            const iv = crypto.getRandomValues(new Uint8Array(12));

            const keyMaterial = await crypto.subtle.digest("SHA-256", enc.encode(secretKey));
            const key = await crypto.subtle.importKey(
                "raw",
                keyMaterial,
                { name: "AES-GCM" },
                false,
                ["encrypt"]
            );

            const encoded = enc.encode(JSON.stringify(data));
            const cipherBuffer = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, encoded);

            const combined = new Uint8Array(iv.length + cipherBuffer.byteLength);
            combined.set(iv);
            combined.set(new Uint8Array(cipherBuffer), iv.length);
            return btoa(String.fromCharCode(...combined));
        }

        async function loadWorld(world) {
            currentWorld = world;
            selectedLevel = null;
            selectedFlag = null;
            currentLevelList = [];
            updatePlay();
            const levels = await fetchLevels(world);
            renderLevels(levels);
        }

        playBtn.onclick = async () => {
            if (!selectedLevel) return;
            if (selectedFlag) {
                try { localStorage.setItem("campaignCurrentFlag", selectedFlag); } catch (_) {}
            }
            const relPath = `data/campaignLevels/world${currentWorld}/${selectedLevel}.json`;
            const rawUrl = `https://raw.githubusercontent.com/over-lords/overlords/main/${relPath}`;
            let json = null;
            try {
                let res = await fetch(relPath);
                if (!res.ok) {
                    res = await fetch(rawUrl);
                }
                if (!res.ok) throw new Error(`Failed to fetch ${selectedLevel}: ${res.status}`);
                json = await res.json();
            } catch (err) {
                alert(`Failed to load campaign level:\n${err}`);
                return;
            }

            // Build payload directly (same shape as single.html start)
            const payload = {
                playerUsernames: ["Player"],
                heroesByPlayer: [Array.isArray(json.heroes) ? json.heroes.map(String) : []],
                heroes: Array.isArray(json.heroes) ? json.heroes.map(String) : [],
                overlords: Array.isArray(json.overlords) ? json.overlords.map(String) : [],
                tactics: Array.isArray(json.tactics) ? json.tactics.map(String) : [],
                enemies: {
                    count: json.enemies?.count || (Array.isArray(json.enemies?.ids) ? json.enemies.ids.length : 0),
                    ids: Array.isArray(json.enemies?.ids) ? json.enemies.ids.map(String) : []
                },
                allies: {
                    count: json.allies?.count || (Array.isArray(json.allies?.ids) ? json.allies.ids.length : 0),
                    ids: Array.isArray(json.allies?.ids) ? json.allies.ids.map(String) : []
                },
                villainDeck: {
                    mights: json.villainDeck?.mights || 0,
                    bystanders: {
                        count: json.villainDeck?.bystanders?.count || 0,
                        byType: Array.isArray(json.villainDeck?.bystanders?.byType) ? json.villainDeck.bystanders.byType : []
                    },
                    scenarios: Array.isArray(json.villainDeck?.scenarios) ? json.villainDeck.scenarios.map(String) : [],
                    henchmen: Array.isArray(json.villainDeck?.henchmen)
                        ? json.villainDeck.henchmen.map(h => ({ id: String(h.id), count: Number(h.count) || 0 }))
                        : [],
                    villains: Array.isArray(json.villainDeck?.villains) ? json.villainDeck.villains.map(String) : []
                }
            };

            try {
                const SECRET = "GeimonHeroKey42";
                const encrypted = await encryptData(payload, SECRET);
                const url = new URL("./game.html", window.location.href);
                url.searchParams.set("data", encrypted);
                window.location.href = url.toString();
            } catch (e) {
                alert("Failed to launch campaign game.\n" + e);
            }
        };

        async function populateWorlds() {
            const worlds = await fetchWorlds();
            worldInput.innerHTML = "";
            worlds.forEach(w => {
                const opt = document.createElement("option");
                opt.value = w;
                opt.textContent = (Number(w) === 1) ? "DC Comics" : `World ${w}`;
                worldInput.appendChild(opt);
            });
            const first = worlds[0] || 1;
            currentWorld = first;
            worldInput.value = String(first);
            await loadWorld(first);
        }

        worldInput.onchange = () => {
            const w = Math.max(1, Number(worldInput.value) || 1);
            currentWorld = w;
            loadWorld(w);
        };

        // Initial load (wait until flags are ready via initializeCampaign)
        window.initializeCampaign = () => {
            populateWorlds();
        };
    </script>
</body>
</html>
